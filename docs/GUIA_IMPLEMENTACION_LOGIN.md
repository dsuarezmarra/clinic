# ?? GUÍA DE IMPLEMENTACIÓN DEL SISTEMA DE LOGIN

## ? Estado Actual: IMPLEMENTACIÓN COMPLETA

### Frontend (Angular)

- ? `src/app/services/auth.service.ts` - Servicio de autenticación con Supabase
- ? `src/app/guards/auth.guard.ts` - Guards para proteger rutas
- ? `src/app/interceptors/auth.interceptor.ts` - Interceptor para añadir JWT
- ? `src/app/pages/login/login.component.ts` - Componente de login
- ? `src/app/pages/login/login.component.html` - Template del login
- ? `src/app/pages/login/login.component.scss` - Estilos del login
- ? `src/app/app.routes.ts` - Rutas actualizadas con guards
- ? `src/app/app.config.ts` - Interceptor de auth registrado
- ? `src/app/app.component.ts` - Métodos logout y isLoginPage
- ? `src/app/app.component.html` - Header con logout y ocultación en login
- ? `src/config/config.loader.ts` - Actualizado para ser SSR-safe
- ? `src/app/services/client-config.service.ts` - Actualizado para SSR
- ? `@supabase/supabase-js` - Instalado

### Backend (Node.js)

- ? `src/middleware/auth.js` - Middleware para validar JWT
- ? `scripts/create-auth-user.js` - Script para crear usuarios

### Base de Datos (Supabase)

- ? `sql/04-setup-auth.sql` - Script para tabla user_profiles

### Testing Local

- ? Build de producción exitoso
- ? Login page visible y funcional en http://localhost:4200/login

---

## ?? PASOS RESTANTES (Manual)

### 1?? Ejecutar Script SQL en Supabase (5 min)

1. Ir a [Supabase Dashboard](https://supabase.com/dashboard)
2. Seleccionar proyecto
3. Ir a **SQL Editor**
4. Copiar contenido de `backend/sql/04-setup-auth.sql`
5. Ejecutar el script

### 2?? Crear Usuario en Supabase Auth (3 min)

**Opción A: Desde Dashboard**

1. Ir a **Authentication > Users**
2. Click en **Add User**
3. Llenar:
   - Email: `fisio@masajecorporaldeportivo.com`
   - Password: `TuPasswordSegura123!`
4. Click en **Create User**
5. Ir a **User Metadata** y añadir:

```json
{
  "tenant_slug": "masajecorporaldeportivo",
  "display_name": "Fisioterapeuta"
}
```

**Opción B: Desde Script (Recomendado)**

```bash
cd backend
node scripts/create-auth-user.js create fisio@masajecorporaldeportivo.com TuPassword123! masajecorporaldeportivo "Juan Garcia"
```

Para Actifisio:

```bash
node scripts/create-auth-user.js create fisio@actifisio.com TuPassword123! actifisio "Fisio Actifisio"
```

### 3?? Verificar Variables de Entorno (2 min)

**Backend (.env):**

```env
SUPABASE_URL=https://tu-proyecto.supabase.co
SUPABASE_ANON_KEY=tu-anon-key
SUPABASE_SERVICE_KEY=tu-service-key
```

**Frontend (ya configurado en auth.service.ts):**
Las credenciales de Supabase están en el AuthService.

### 4?? Probar Localmente (5 min)

```bash
# Terminal 1 - Backend
cd backend
npm run dev

# Terminal 2 - Frontend
cd frontend
ng serve
```

1. Abrir `http://localhost:4200`
2. Debería redirigir a `/login`
3. Iniciar sesión con las credenciales creadas
4. Verificar acceso a la aplicación

### 5?? Deploy a Vercel (10 min)

```bash
# Frontend
cd frontend
ng build
# El deploy a Vercel es automático si está configurado

# Backend
cd backend
# Commit y push para trigger deploy automático
```

---

## ?? Funcionalidades Implementadas

### Login Page

- ? Formulario de email/contraseña
- ? Validaciones (email requerido, formato válido)
- ? Mostrar/ocultar contraseña
- ? Opción "Olvidé mi contraseña"
- ? Mensajes de error en español
- ? Loading state durante login
- ? Estilos dinámicos por cliente (colores del tema)

### Autenticación

- ? Login con Supabase Auth
- ? Sesión persistente (localStorage)
- ? Auto-refresh de tokens
- ? Logout con limpieza de sesión
- ? Verificación de tenant (usuario solo accede a su clínica)

### Recuperación de Contraseña

- ? Envío de email de recuperación
- ? Página de reset password
- ? Actualización de contraseña

### Protección de Rutas

- ? Rutas protegidas: /inicio, /agenda, /pacientes, /configuracion
- ? Rutas públicas: /login, /reset-password
- ? Redirección automática a login si no autenticado
- ? Redirección a inicio si ya autenticado

### Header

- ? Header oculto en página de login
- ? Botón de logout visible cuando autenticado
- ? Email del usuario mostrado

---

## ?? Arquitectura

```
???????????????????????????????????????????????????????????????
?                        Frontend (Angular)                    ?
?                                                              ?
?  ????????????????    ????????????????    ????????????????   ?
?  ? LoginPage    ????>? AuthService  ????>? Supabase JS  ?   ?
?  ?              ?    ?              ?    ?   Client     ?   ?
?  ????????????????    ????????????????    ????????????????   ?
?          ?                   ?                   ?          ?
?          v                   v                   v          ?
?  ????????????????    ????????????????    ????????????????   ?
?  ? AuthGuard    ?    ?AuthInterceptor?   ? localStorage ?   ?
?  ?  (Routes)    ?    ? (HTTP + JWT) ?    ?   (Token)    ?   ?
?  ????????????????    ????????????????    ????????????????   ?
???????????????????????????????????????????????????????????????
                              ?
                              v (HTTP + Bearer Token + X-Tenant-Slug)
???????????????????????????????????????????????????????????????
?                        Backend (Express)                     ?
?                                                              ?
?  ????????????????    ????????????????    ????????????????   ?
?  ? auth.js      ????>?  Routes      ????>?  Supabase    ?   ?
?  ? middleware   ?    ?  (API)       ?    ?   Client     ?   ?
?  ????????????????    ????????????????    ????????????????   ?
???????????????????????????????????????????????????????????????
                              ?
                              v
???????????????????????????????????????????????????????????????
?                      Supabase (PostgreSQL)                   ?
?                                                              ?
?  ????????????????    ????????????????    ????????????????   ?
?  ? auth.users   ????>?user_profiles ?    ? tenants      ?   ?
?  ? (Supabase)   ?    ? (custom)     ?    ?              ?   ?
?  ????????????????    ????????????????    ????????????????   ?
???????????????????????????????????????????????????????????????
```

---

## ??? Seguridad

1. **JWT Tokens**: Supabase Auth genera tokens JWT seguros
2. **Token Refresh**: Auto-refresh antes de expiración
3. **Tenant Validation**: Usuario solo accede a su clínica
4. **RLS**: Row Level Security en Supabase (opcional para backend)
5. **HTTPS**: Vercel maneja SSL automáticamente

---

## ?? Notas Importantes

1. **Un usuario por clínica**: Cada fisio tiene su propio login
2. **Sin roles**: Todos los usuarios tienen acceso completo
3. **Multi-tenant**: Validación de tenant_slug en metadata
4. **Sesión persistente**: Token guardado en localStorage
5. **Recovery por email**: Supabase envía emails automáticamente

---

## ?? Troubleshooting

### Error "Este usuario no tiene acceso a esta clínica"

- Verificar que `tenant_slug` en user_metadata coincide con el cliente

### Error "Invalid login credentials"

- Verificar email y contraseña
- Verificar que el usuario existe en Supabase Auth

### No redirige después de login

- Verificar consola del navegador para errores
- Limpiar localStorage y probar de nuevo

### Token no se envía en peticiones

- Verificar que authInterceptor está registrado en app.config.ts
- Verificar que hay token en localStorage

---

**Última actualización:** $(Get-Date -Format "yyyy-MM-dd HH:mm")
