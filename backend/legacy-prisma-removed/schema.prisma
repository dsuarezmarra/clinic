generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Patient {
  id             String        @id @default(uuid())
  dni            String        @unique
  firstName      String
  lastName       String
  phone          String
  email          String?       @unique
  address        String?
  cp             String?
  city           String?
  province       String?
  birthDate      DateTime?
  notes          String?
  fechaRegistro  DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  family_contact String?
  phone2         String?
  appointments   Appointment[]
  creditPacks    CreditPack[]
  invoices       Invoice[]
  files          PatientFile[]

  @@map("patients")
}

model PatientFile {
  id           String   @id @default(uuid())
  patientId    String
  originalName String
  storedPath   String
  mimeType     String
  size         Int
  category     String   @default("otro")
  description  String?
  checksum     String?
  createdAt    DateTime @default(now())
  patient      Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@map("patient_files")
}

model Appointment {
  id                String             @id @default(uuid())
  patientId         String?
  start             DateTime
  end               DateTime
  durationMinutes   Int                @default(30)
  priceCents        Int?
  status            String             @default("BOOKED")
  notes             String?
  consumesCredit    Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  patient           Patient?           @relation(fields: [patientId], references: [id])
  creditRedemptions CreditRedemption[]
  invoiceItems      InvoiceItem[]

  @@map("appointments")
}

model CreditPack {
  id                String             @id @default(uuid())
  patientId         String
  label             String
  unitsTotal        Int
  unitMinutes       Int                @default(30)
  priceCents        Int                @default(0)
  unitsRemaining    Int
  paid              Boolean            @default(false)
  notes             String?
  createdAt         DateTime           @default(now())
  patient           Patient            @relation(fields: [patientId], references: [id], onDelete: Cascade)
  creditRedemptions CreditRedemption[]

  @@map("credit_packs")
}

model CreditRedemption {
  id            String      @id @default(uuid())
  creditPackId  String
  appointmentId String
  unitsUsed     Int
  createdAt     DateTime    @default(now())
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  creditPack    CreditPack  @relation(fields: [creditPackId], references: [id], onDelete: Cascade)

  @@map("credit_redemptions")
}

model Configuration {
  key   String @id
  value String

  @@map("configurations")
}

model Invoice {
  id           String        @id @default(uuid())
  number       String        @unique
  year         Int
  sequence     Int
  patientId    String?
  issueDate    DateTime      @default(now())
  grossAmount  Int
  vatAmount    Int
  totalAmount  Int
  description  String?
  createdAt    DateTime      @default(now())
  invoiceItems InvoiceItem[]
  patient      Patient?      @relation(fields: [patientId], references: [id])

  @@map("invoices")
}

model InvoiceItem {
  id            String       @id @default(uuid())
  invoiceId     String
  appointmentId String?
  description   String
  quantity      Int          @default(1)
  unitPrice     Int
  totalPrice    Int
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])
  invoice       Invoice      @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("invoice_items")
}
