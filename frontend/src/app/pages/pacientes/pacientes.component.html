<div class="container-fluid">
    <!-- Header con título y botón para agregar -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2 class="mb-0">
                <i class="bi bi-people-fill me-2"></i>
                Gestión de Pacientes
            </h2>
            <p class="text-muted">Administra la información de tus pacientes</p>
        </div>
        <div class="col-md-4 text-end">
            <button type="button" class="btn btn-primary" (click)="toggleCreateForm()"
                [class.btn-secondary]="showCreateForm">
                <i class="bi bi-plus-circle me-2"></i>
                {{ showCreateForm ? 'Cancelar' : 'Nuevo Paciente' }}
            </button>
        </div>
    </div>

    <!-- Formulario para crear/editar paciente -->
    <div class="row mb-4" *ngIf="showCreateForm || selectedPatient">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-person-plus me-2"></i>
                        {{ selectedPatient ? 'Editar Paciente' : 'Nuevo Paciente' }}
                    </h5>
                </div>
                <div class="card-body">
                    <form (ngSubmit)="savePatient()" #patientForm="ngForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="firstName" class="form-label">Nombre *</label>
                                <input type="text" class="form-control" id="firstName" name="firstName"
                                    [(ngModel)]="patientFormData.firstName" required placeholder="Ingrese el nombre"
                                    autofocus tabindex="0" style="z-index: 1060;">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="lastName" class="form-label">Apellidos *</label>
                                <input type="text" class="form-control" id="lastName" name="lastName"
                                    [(ngModel)]="patientFormData.lastName" required placeholder="Ingrese los apellidos"
                                    tabindex="0" style="z-index: 1060;">

                                <!-- DNI colocado inmediatamente después de Apellidos -->
                                <div class="mt-3">
                                    <label for="dni" class="form-label">
                                        DNI * 
                                        <small class="text-muted ms-2">
                                            <i class="bi bi-info-circle me-1"></i>Campo único
                                        </small>
                                    </label>
                                    <input type="text" class="form-control" id="dni" name="dni"
                                        [(ngModel)]="patientFormData.dni" required placeholder="DNI del paciente"
                                        tabindex="0" style="z-index: 1060;">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="phone" class="form-label">Teléfono *</label>
                                <input type="tel" class="form-control" id="phone" name="phone"
                                    [(ngModel)]="patientFormData.phone" required placeholder="Ej: +34 123 456 789"
                                    tabindex="0" style="z-index: 1060;">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="phone2" class="form-label">Teléfono 2</label>
                                <input type="tel" class="form-control" id="phone2" name="phone2"
                                    [(ngModel)]="patientFormData.phone2" placeholder="Teléfono alternativo"
                                    tabindex="0" style="z-index: 1060;">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label">
                                    Email 
                                    <small class="text-muted ms-2">
                                        <i class="bi bi-info-circle me-1"></i>Campo único
                                    </small>
                                </label>
                                <input type="email" class="form-control" id="email" name="email"
                                    [(ngModel)]="patientFormData.email" placeholder="Ej: correo@ejemplo.com"
                                    tabindex="0" style="z-index: 1060;">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="family_contact" class="form-label">Contacto Familiar</label>
                                <input type="text" class="form-control" id="family_contact" name="family_contact"
                                    [(ngModel)]="patientFormData.family_contact" placeholder="Familiar de contacto"
                                    tabindex="0" style="z-index: 1060;">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="birthDate" class="form-label">Fecha de Nacimiento</label>
                                <input type="date" class="form-control" id="birthDate" name="birthDate"
                                    [(ngModel)]="patientFormData.birthDate" tabindex="0" style="z-index: 1060;">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="address" class="form-label">Dirección</label>
                                <input type="text" class="form-control" id="address" name="address"
                                    [(ngModel)]="patientFormData.address" placeholder="Dirección completa del paciente"
                                    tabindex="0" style="z-index: 1060;">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="cp" class="form-label">CP</label>
                                <input type="text" class="form-control" id="cp" name="cp" maxlength="5"
                                    [(ngModel)]="patientFormData.cp" (ngModelChange)="onCpChange($any($event))"
                                    pattern="\\d{5}" placeholder="Ej: 28001" tabindex="0" style="z-index: 1060;">
                            </div>

                            <!-- Mostrar siempre Localidad antes de Provincia (usuario pidió permutar) -->
                            <div class="col-md-4 mb-3">
                                <label for="city" class="form-label">Localidad</label>
                                <select class="form-select" id="city" name="city" [(ngModel)]="patientFormData.city"
                                    tabindex="0" style="z-index: 1060;">
                                    <option value="" disabled *ngIf="!patientFormData.city">Seleccione una
                                        localidad</option>
                                    <option *ngFor="let c of locationCities" [value]="c">{{ c }}</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="province" class="form-label">Provincia</label>
                                <select class="form-select" id="province" name="province"
                                    [(ngModel)]="patientFormData.province" (ngModelChange)="onProvinceChange($any($event))"
                                    tabindex="0" style="z-index: 1060;">
                                    <option value="" disabled *ngIf="!patientFormData.province">Seleccione
                                        una provincia</option>
                                    <option *ngFor="let p of locationProvinces" [value]="p.name">{{ p.name }}
                                    </option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="notes" class="form-label">Notas</label>
                            <textarea class="form-control" id="notes" name="notes" [(ngModel)]="patientFormData.notes"
                                rows="3" placeholder="Notas adicionales sobre el paciente..." tabindex="0" style="z-index: 1060;"></textarea>
                        </div>

                        <!-- Recordatorios WhatsApp -->
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="whatsappReminders" 
                                    name="whatsappReminders" [(ngModel)]="patientFormData.whatsappReminders">
                                <label class="form-check-label" for="whatsappReminders">
                                    <i class="bi bi-whatsapp text-success me-1"></i>
                                    Enviar recordatorios por WhatsApp (24h antes de cada cita)
                                </label>
                                <div class="form-text">
                                    Si está activado y el paciente tiene móvil, recibirá un mensaje automático recordándole su cita.
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-success" [disabled]="!canSave()">
                                <i class="bi bi-check-circle me-2"></i>
                                {{ selectedPatient ? 'Actualizar' : 'Guardar' }}
                            </button>
                            <button type="button" class="btn btn-secondary" (click)="cancelForm()">
                                <i class="bi bi-x-circle me-2"></i>
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Barra de búsqueda -->
    <!-- Barra de búsqueda y controles de paginación -->
    <div class="row mb-3 g-2 align-items-center">
        <!-- Búsqueda -->
        <div class="col-12 col-lg-4 mb-2 mb-lg-0">
            <div class="input-group">
                <span class="input-group-text">
                    <i class="bi bi-search"></i>
                </span>
                <input type="text" class="form-control" placeholder="Buscar por nombre, apellido o teléfono..."
                    [(ngModel)]="searchTerm" (input)="filterPatients()" autofocus tabindex="0" style="z-index: 1060;">
            </div>
        </div>
        
        <!-- Mostrar por página -->
        <div class="col-6 col-sm-auto mb-2 mb-lg-0">
            <div class="input-group input-group-sm flex-nowrap">
                <span class="input-group-text">Mostrar</span>
                <select class="form-select" [(ngModel)]="pageSize" (change)="onPageSizeChange()" style="width: auto;">
                    <option *ngFor="let size of pageSizeOptions" [value]="size">{{size}}</option>
                </select>
                <span class="input-group-text text-nowrap">por página</span>
            </div>
        </div>
        
        <!-- Total pacientes -->
        <div class="col-6 col-sm-auto mb-2 mb-lg-0 text-end text-sm-start">
            <span class="badge bg-secondary fs-6 text-nowrap">
                {{ totalPatients }} pacientes
            </span>
        </div>
        
        <!-- Paginación -->
        <div class="col-12 col-lg-auto ms-lg-auto">
            <nav *ngIf="totalPages > 1">
                <ul class="pagination pagination-sm mb-0 justify-content-center justify-content-lg-end flex-wrap">
                    <li class="page-item" [class.disabled]="currentPage <= 1">
                        <button class="page-link d-flex align-items-center justify-content-center" (click)="previousPage()" [disabled]="currentPage <= 1">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                    </li>
                    
                    <li class="page-item" *ngFor="let page of getPageRange()" 
                        [class.active]="page === currentPage">
                        <button class="page-link d-flex align-items-center justify-content-center" (click)="goToPage(page)">{{page}}</button>
                    </li>
                    
                    <li class="page-item" [class.disabled]="currentPage >= totalPages">
                        <button class="page-link d-flex align-items-center justify-content-center" (click)="nextPage()" [disabled]="currentPage >= totalPages">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    </li>
                </ul>
            </nav>
        </div>
    </div>

    <!-- Loading skeleton -->
    <div class="row" *ngIf="loading">
        <div class="col-12">
            <div class="card animate-fade-in">
                <div class="card-body p-0">
                    <div class="table-responsive d-none d-md-block">
                        <table class="table mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Paciente</th>
                                    <th>Contacto</th>
                                    <th>Notas</th>
                                    <th>Sesiones</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let i of [1,2,3,4,5]">
                                    <td>
                                        <div class="skeleton skeleton-text" style="width: 150px;"></div>
                                        <div class="skeleton skeleton-text" style="width: 80px; height: 0.8em;"></div>
                                    </td>
                                    <td>
                                        <div class="skeleton skeleton-text" style="width: 120px;"></div>
                                        <div class="skeleton skeleton-text" style="width: 180px; height: 0.8em;"></div>
                                    </td>
                                    <td>
                                        <div class="skeleton skeleton-text" style="width: 200px;"></div>
                                    </td>
                                    <td>
                                        <div class="skeleton" style="width: 30px; height: 24px; border-radius: 12px;"></div>
                                    </td>
                                    <td class="text-center">
                                        <div class="d-flex gap-1 justify-content-center">
                                            <div class="skeleton" style="width: 60px; height: 30px;"></div>
                                            <div class="skeleton" style="width: 60px; height: 30px;"></div>
                                            <div class="skeleton" style="width: 60px; height: 30px;"></div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de pacientes -->
    <div class="row" *ngIf="!loading">
        <div class="col-12">
            <div class="card">
                <div class="card-body p-0">
                    <!-- Vista de tabla para pantallas grandes -->
                    <div class="table-responsive d-none d-md-block">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Paciente</th>
                                    <th>Contacto</th>
                                    <th>Notas</th>
                                    <th>Sesiones</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let patient of filteredPatients; trackBy: trackByPatientId">
                                    <td>
                                        <div>
                                            <strong (click)="viewPatient(patient)" style="cursor:pointer;">{{
                                                getFullName(patient) }}</strong>
                                            <div class="text-muted small" *ngIf="patient.birthDate">
                                                {{ calculateAge(patient.birthDate) }} años
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div>
                                            <a href="tel:{{ patient.phone }}" class="text-decoration-none d-block">
                                                <i class="bi bi-telephone-fill me-1 text-primary"></i>
                                                {{ patient.phone }}
                                            </a>
                                            <a href="tel:{{ patient.phone2 }}" class="text-decoration-none d-block" 
                                                *ngIf="patient.phone2">
                                                <i class="bi bi-telephone me-1 text-success"></i>
                                                {{ patient.phone2 }}
                                            </a>
                                            <a href="mailto:{{ patient.email }}"
                                                class="text-decoration-none text-muted small d-block"
                                                *ngIf="patient.email">
                                                <i class="bi bi-envelope me-1"></i>
                                                {{ patient.email }}
                                            </a>
                                            <div class="text-muted small" *ngIf="patient.family_contact">
                                                <i class="bi bi-people me-1"></i>
                                                {{ patient.family_contact }}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="text-muted small" *ngIf="patient.notes; else noNotes">
                                            <i class="bi bi-chat-text me-1"></i>
                                            <span class="d-inline-block text-truncate" style="max-width: 200px;" 
                                                  [title]="patient.notes">
                                                {{ patient.notes }}
                                            </span>
                                        </div>
                                        <ng-template #noNotes>
                                            <span class="text-muted small">-</span>
                                        </ng-template>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="badge bg-info">
                                                {{ patient.activeSessions || 0 }}
                                            </span>
                                            <button type="button" class="btn btn-sm btn-outline-primary"
                                                (click)="addSessionsToPatient(patient)" title="Añadir Sesiones">
                                                <i class="bi bi-plus-circle"></i>
                                            </button>
                                            <!-- Precio previsualizado del primer pack disponible -->
                                            <small class="text-muted ms-2" *ngIf="patient['pricePreview']">{{
                                                patient['pricePreview'] }}</small>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group action-buttons" role="group">
                                            <button type="button" class="btn btn-sm btn-outline-primary action-btn"
                                                (click)="viewPatient(patient)" title="Ver detalles del paciente">
                                                <i class="bi bi-eye"></i>
                                                <span class="btn-text">Ver</span>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-warning action-btn"
                                                (click)="editPatient(patient)" title="Editar información del paciente">
                                                <i class="bi bi-pencil"></i>
                                                <span class="btn-text">Editar</span>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger action-btn"
                                                (click)="deletePatient(patient)" title="Eliminar paciente">
                                                <i class="bi bi-trash"></i>
                                                <span class="btn-text">Borrar</span>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Vista de tarjetas para móviles -->
                    <div class="d-md-none">
                        <div class="p-3" *ngFor="let patient of filteredPatients; trackBy: trackByPatientId">
                            <div class="card mb-2">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h6 class="card-title mb-1">
                                                <span (click)="viewPatient(patient)" style="cursor:pointer;">
                                                    {{ getFullName(patient) }}
                                                </span>
                                            </h6>
                                            <div class="text-muted small mb-1" *ngIf="patient.birthDate">
                                                {{ calculateAge(patient.birthDate) }} años
                                            </div>
                                            <p class="card-text small text-muted mb-1">
                                                <i class="bi bi-telephone-fill me-1 text-primary"></i>
                                                <a href="tel:{{ patient.phone }}" class="text-decoration-none">
                                                    {{ patient.phone }}
                                                </a>
                                            </p>
                                            <p class="card-text small text-muted mb-1" *ngIf="patient.phone2">
                                                <i class="bi bi-telephone me-1 text-success"></i>
                                                <a href="tel:{{ patient.phone2 }}" class="text-decoration-none">
                                                    {{ patient.phone2 }}
                                                </a>
                                            </p>
                                            <p class="card-text small text-muted mb-1" *ngIf="patient.email">
                                                <i class="bi bi-envelope me-1"></i>
                                                <a href="mailto:{{ patient.email }}" class="text-decoration-none">
                                                    {{ patient.email }}
                                                </a>
                                            </p>
                                            <p class="card-text small text-muted mb-2" *ngIf="patient.family_contact">
                                                <i class="bi bi-people me-1"></i>
                                                {{ patient.family_contact }}
                                            </p>
                                            <p class="card-text small text-muted mb-2" *ngIf="patient.notes">
                                                <i class="bi bi-chat-text me-1"></i>
                                                {{ patient.notes }}
                                            </p>
                                            <div class="d-flex gap-2 align-items-center">
                                                <span class="badge bg-info">{{ patient.activeSessions || 0 }}</span>
                                                <button type="button" class="btn btn-sm btn-outline-primary"
                                                    (click)="addSessionsToPatient(patient)" title="Añadir Sesiones">
                                                    <i class="bi bi-plus-circle"></i>
                                                </button>
                                                <span class="badge bg-secondary">{{ patient._count?.appointments || 0 }}</span>
                                                <div class="ms-2 text-muted small" *ngIf="patient['pricePreview']">{{
                                                    patient['pricePreview'] }}</div>
                                            </div>
                                        </div>
                                        <div class="dropdown">
                                            <button class="btn btn-outline-secondary btn-sm dropdown-toggle"
                                                type="button" data-bs-toggle="dropdown">
                                                <i class="bi bi-three-dots-vertical"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li>
                                                    <a class="dropdown-item" (click)="viewPatient(patient)">
                                                        <i class="bi bi-eye me-2"></i>Ver detalles
                                                    </a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" (click)="editPatient(patient)">
                                                        <i class="bi bi-pencil me-2"></i>Editar
                                                    </a>
                                                </li>
                                                <li>
                                                    <hr class="dropdown-divider">
                                                </li>
                                                <li>
                                                    <a class="dropdown-item text-danger"
                                                        (click)="deletePatient(patient)">
                                                        <i class="bi bi-trash me-2"></i>Eliminar
                                                    </a>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Paginación adicional al final de la tabla -->
            <div class="row mt-3" *ngIf="totalPages > 1 && !loading && filteredPatients.length > 0">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="text-muted">
                            Mostrando {{ (currentPage - 1) * pageSize + 1 }} - {{ Math.min(currentPage * pageSize, totalPatients) }} 
                            de {{ totalPatients }} pacientes
                        </div>
                        <nav>
                            <ul class="pagination mb-0">
                                <li class="page-item" [class.disabled]="currentPage <= 1">
                                    <button class="page-link d-flex align-items-center justify-content-center" (click)="previousPage()" [disabled]="currentPage <= 1">
                                        <i class="bi bi-chevron-left"></i>
                                    </button>
                                </li>
                                
                                <li class="page-item" *ngFor="let page of getPageRange()" 
                                    [class.active]="page === currentPage">
                                    <button class="page-link d-flex align-items-center justify-content-center" (click)="goToPage(page)">{{page}}</button>
                                </li>
                                
                                <li class="page-item" [class.disabled]="currentPage >= totalPages">
                                    <button class="page-link d-flex align-items-center justify-content-center" (click)="nextPage()" [disabled]="currentPage >= totalPages">
                                        <i class="bi bi-chevron-right"></i>
                                    </button>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mensaje cuando no hay pacientes -->
    <div class="empty-state animate-fade-in-up" *ngIf="!loading && filteredPatients.length === 0">
        <div class="empty-state-icon">
            <i class="bi bi-people"></i>
        </div>
        <h4 class="empty-state-title">
            {{ searchTerm ? 'No se encontraron pacientes' : 'No hay pacientes registrados' }}
        </h4>
        <p class="empty-state-description">
            {{ searchTerm ? 'Intenta con otros términos de búsqueda' : 'Comienza agregando tu primer paciente para gestionar sus citas y sesiones' }}
        </p>
        <button type="button" class="btn btn-primary btn-ripple" (click)="showCreateForm = true" *ngIf="!searchTerm">
            <i class="bi bi-plus-circle me-2"></i>
            Agregar Primer Paciente
        </button>
        <button type="button" class="btn btn-outline-secondary" (click)="searchTerm = ''; filterPatients()" *ngIf="searchTerm">
            <i class="bi bi-x-circle me-2"></i>
            Limpiar búsqueda
        </button>
    </div>
</div>

<!-- Modal para añadir Sesiones/Sesiones -->
<div class="row mb-4" *ngIf="showAddCreditForm">
    <div class="col-12">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-credit-card me-2"></i>
                    Añadir sesiones o bonos - {{ selectedPatientForCredits?.firstName }} {{
                    selectedPatientForCredits?.lastName }}
                </h5>
                <button type="button" class="btn-close btn-close-white" (click)="hideCreditForm()"></button>
            </div>
            <div class="card-body">
                <form (ngSubmit)="addCredits()" #creditForm="ngForm">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="creditType" class="form-label">Tipo *</label>
                            <select class="form-select" id="creditType" name="creditType"
                                [(ngModel)]="creditFormData.type" (ngModelChange)="onFormValueChange()"
                                (change)="onFormValueChange()" required
                                tabindex="0" style="z-index: 1060;">
                                <option value="sesion">Sesión</option>
                                <option value="bono">Bono</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="creditMinutes" class="form-label">Duración *</label>
                            <select class="form-select" id="creditMinutes" name="creditMinutes"
                                [(ngModel)]="creditFormData.minutes" (ngModelChange)="onFormValueChange()"
                                (change)="onFormValueChange()" required
                                tabindex="0" style="z-index: 1060;">
                                <option value="30">30 minutos (1/2h sesión)</option>
                                <option value="60">60 minutos (1h sesión)</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="creditQuantity" class="form-label">Cantidad *</label>
                            <input type="number" class="form-control" id="creditQuantity" name="creditQuantity"
                                [(ngModel)]="creditFormData.quantity" (ngModelChange)="onFormValueChange()"
                                (input)="onFormValueChange()" required min="1" max="20" placeholder="Ej: 5"
                                autofocus tabindex="0" style="z-index: 1060;">
                        </div>
                        <div class="col-md-3 mb-3 d-flex align-items-end">
                            <div class="w-100">
                                <div class="text-muted small">Total a crear:</div>
                                <div class="fw-bold text-primary">
                                    {{ equivalentSessions }} sesiones de 1/2h (30 min)
                                </div>
                                <div class="text-muted small"
                                    *ngIf="creditFormData.type === 'bono' || creditFormData.minutes === 60">
                                    Original: {{ creditFormData.quantity || 0 }} {{ creditFormData.type ===
                                    'bono' ? 'bono(s)' : 'sesión(es)' }} de {{ creditFormData.minutes }} min
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="creditNotes" class="form-label">Notas</label>
                        <textarea class="form-control" id="creditNotes" name="creditNotes"
                            [(ngModel)]="creditFormData.notes" rows="2"
                            placeholder="Notas adicionales sobre estas sesiones..."
                            tabindex="0" style="z-index: 1060;"></textarea>
                    </div>

                    <!-- Campo Pagado -->
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="creditPaid" name="creditPaid"
                                [(ngModel)]="creditFormData.paid"
                                tabindex="0" style="z-index: 1060;">
                            <label class="form-check-label" for="creditPaid">
                                <i class="bi bi-credit-card-2-front me-2"></i>
                                <strong>Pagado</strong>
                            </label>
                            <div class="form-text">
                                Marcar si el pago de estas sesiones ya ha sido recibido
                            </div>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-success" [disabled]="!creditForm.form.valid || loading">
                            <i class="bi bi-check-circle me-2"></i>
                            Añadir
                        </button>
                        <button type="button" class="btn btn-secondary" (click)="hideCreditForm()">
                            <i class="bi bi-x-circle me-2"></i>
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmación para eliminar paciente -->
<app-confirm-modal
    [isOpen]="showDeleteConfirm"
    title="Eliminar Paciente"
    message="¿Está seguro de que desea eliminar este paciente?"
    details="Esta acción eliminará también todas sus citas, packs de sesiones y archivos asociados. Esta acción no se puede deshacer."
    itemLabel="Paciente"
    [itemName]="patientToDelete ? getFullName(patientToDelete) : ''"
    confirmText="Eliminar"
    type="danger"
    [loading]="deleteLoading"
    (confirm)="confirmDeletePatient()"
    (cancel)="cancelDeletePatient()">
</app-confirm-modal>